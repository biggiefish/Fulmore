---
title: "Fulmore River Sockeye Salmon Smolt Enumeration"
author: "Eric V"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_caption: yes
    code_folding: show
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Project Background
 
This is a live document intended to present preliminary information about juvenile salmon captured in the Fulmore River by rotary screw trap. The Fulmore River is located in the traditional territory of the Tlowitsis First Nation, at the head of Port Neville, approximately 80 NE of Campbell River. The trap was installed on April 11-12 and will fish roughly 5-days a week (Monday to Friday) until June 15, 2024. All fish captured in the trap will be identified to species and measured for fork length. Biological samples will be collected from a subset of fish each day. Releases of marked fish will occur weekly to assess trap efficiency. 

```{r prepare working environment, echo=FALSE, warning = FALSE, message = FALSE}
## Load Packages
    library(tidyverse)
    library(tidyr)
    library(dplyr)
    library(zoo)
    library(lubridate)
    library(reshape2)
    library(ggplot2)
    library(readxl)
    library(kableExtra)
    library(markdown)
    library(captioner)

## Define Working Directory ---
setwd("C:/Users/evogt/R Analysis/EAV/GitHubMarkdown/Fulmore/docs/")

## Define and Load Input Files
  #1. PacFish Temp and Flow Data
    #catch_dat <- "Data/RST Catch/RST_Catch_2024.05.02.xlsx"
    #catch_dat <- read_excel(catch_dat)

    catch_dat <- "Data/RST Catch/StandardFishCollectionComplete_29389-1.xlsx"
    data <- read_excel(catch_dat, sheet = "Fish Data")
 
  ## Define Output Locations
    plot.output <- "Plots/"
    model.output <- "Output/"

## Load Ecofish Plot Theme ----          
    plottheme = function() {
      theme(
        legend.key.size = unit(0.75, "lines"),
        legend.key = element_blank(),
        legend.title = element_text(size = 9, face = "bold"),
        legend.text = element_text(size = 9),
        plot.title = element_text(size = 8, face = "bold"),
        axis.line = element_line(colour = "grey", size = 1),
        panel.grid.major.y = element_line(colour = "gray", linetype = "dashed"),
        panel.grid.major.x = element_line(colour = "gray"),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "gray40", fill = NA),
        panel.background = element_rect(fill = NA, colour = "gray40"),
        axis.title = element_text(face = "bold", size = 9),
        axis.text = element_text(size = 8, colour = "black"),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(2, 5, 2, 2), "mm"),
        strip.background = element_blank(),
        strip.text = element_text(size = 8, face = "bold")
      )
    }          

```


```{r prep catch_dat,, echo = FALSE, message = FALSE, warning = FALSE}
## Prepare Data
catch_dat <- data %>%                   
                 rename(Length = "Measured Length (mm)",
                        Length.Est = "Estimated Length (mm)",
                        Weight = "Weight (g)",
                        Date = "Date (YYYY-MM-DD)") %>%
                 mutate(Condition = 100*(Weight/(Length^3)),
                        Species = recode(as.factor(Species), 
                                             SK        = "Sockeye Salmon",
                                             CO        = "Coho Salmon",
                                             CM        = "Chum Salmon",
                                             CT        = "Coastal Cutthroat",
                                             'BT/DV'   = "Dolly Varden",
                                             CC        = "Coastal Sculpin",
                                             L         = "Pacific Lamprey",
                                            TSB        = "Three-Spine Stickleback"),
                             Species = factor(Species, 
                                              levels = c("Sockeye Salmon", "Coho Salmon", "Chum Salmon", 
                                                         "Coastal Cutthroat", "Dolly Varden", "Coastal Sculpin", 
                                                         "Pacific Lamprey", "Three-Spine Stickleback")))
    
spp_summary <- catch_dat %>% 
                  group_by(Species) %>%
                  summarize(Count = n())

```

## Captures to Date

Since April 15, the trap has fished for a total of `r (length(unique(catch_dat$Date)))` days, resulting in the capture of Sockeye Salmon, Coho Salmon, one Chum Salmon, Coastal Cutthroat Trout, Dolly Varden Char, Pacific Lamprey, Sculpin (Cottidae spp.) and sticklebacks.
 
```{r tallytable, echo = FALSE, message = FALSE, warning = FALSE}
## Prepare summary table
    tally.table <- catch_dat %>% 
                      group_by(Species) %>%
                              summarize(count = n(),
                                        nFL     = sum(Length >0, na.rm = TRUE),
                                        meanFL  = mean(Length, na.rm = TRUE),
                                        minFL   = min(Length, na.rm = TRUE),
                                        maxFL   = max(Length, na.rm = TRUE),
                                        nWT     = sum(Weight > 0, na.rm=TRUE),
                                        meanWT  = mean(Weight, na.rm = TRUE),
                                        minWT   = min(Weight, na.rm = TRUE),
                                        maxWT   = max(Weight, na.rm = TRUE))

## Prepare Kable Table
    kable(tally.table,
          "html",
          booktabs = T,
          align = c("c"),
          col.names = c("Species", "Total \n Captures","n", "Mean", "Min", "Max", "n", "Mean", "Min", "Max"),
          caption = "Summary of total number and biological data collected of fish captured since April 15, 2024.",
          digits = 1) %>%
      #column_spec(c(1, 3,10,17), bold = TRUE) %>%
      kable_styling("striped", full_width =  FALSE,
                    position = "center", 
                    font_size = 12,
                    fixed_thead = TRUE) %>%
      add_header_above(c(" " = 2, "Fork Length" = 4, "Weight (g)" = 4)) 
```

# Sockeye Salmon

The length-frequency distribution for Sockeye Salmon smolts is multimodal (separating at ~120 mm), indicating at least two groups of different sized fish are emigrating simultaneously. Scale aging will be required to verify whether this difference is due to difference age classes, though it is also possible that some of the variability is explained by a difference in productivity between rearing environments (e.g., smolts may be the same age, but smolts that reared in a more productive environment (e.g., Fulmore Lake) may be larger than smolts that reared in a tributary). 

```{r length frequency plot for all sockeye, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Length-frequency distribution for Sockeye Salmon captured in the Fulmore River.", message = FALSE, fig.dim=c(10,18)}
## Total tally by fork length
SK_LF_data <- catch_dat %>% 
#all_catches <- catch_dat %>%   
               filter(Species == "Sockeye Salmon") %>%
               group_by(Species, Length) %>%
                   summarize(Count = n()) %>%
                   mutate(Date = "All Dates") %>%
                   select("Species","Length","Count") 
               

all_catch_LFreq.plot <- ggplot(SK_LF_data, aes(x = Length, y = Count))+
                        geom_col() +
                        labs(x = "Fork Length (mm)", y = "Frequency") + 
                        scale_x_continuous(breaks = seq(20, 210, by = 20))+
                        facet_grid(Species~.) +
                        plottheme()

all_catch_LFreq.plot
```

```{r smolt proportion, echo = FALSE, warning = FALSE, message = FALSE}
SK_dat <- catch_dat %>% 
              filter(Species == "Sockeye Salmon") %>%
              mutate(AgeClass =ifelse(Length>=175,"Age-3",
                                      ifelse(Length>120,"Age-2","Age-1")),
                     TotalCount = n()) %>%
              filter(!is.na(AgeClass))

SK_prop <- SK_dat %>%
              group_by(AgeClass,TotalCount) %>%
              summarize(Count  = n(),
                        nFL = sum(!is.na(Length)),
                        MeanFL = mean(Length, na.rm = TRUE),
                        SEFL   = sd(Length, na.rm = TRUE)/sqrt(Count),
                        MinFL  = min(Length, na.rm = TRUE),
                        MaxFL  = max(Length, na.rm = TRUE),
                        nWT    = sum(!is.na(Weight)),
                        MeanWT = mean(Weight, na.rm = TRUE),
                        SEWT   = sd(Weight, na.rm = TRUE)/sqrt(Count),
                        MinWT  = min(Weight, na.rm = TRUE),
                        MaxWT  = max(Weight, na.rm = TRUE))%>%
              mutate(Prop = (Count/TotalCount)*100) %>% 
              select("AgeClass" ,"Count","Prop","nFL", "MeanFL", "SEFL", "MinFL", "MaxFL", "nWT", "MeanWT","SEWT", "MinWT","MaxWT") %>%
              filter(AgeClass != "NA")


kable(SK_prop,
      "html",
      booktabs = T,
      align = c("c"),
      col.names = c("Age Class", "n", "Prop (%)","n" ,"Mean", "SE","Min", "Max", "n","Mean", "SE","Min", "Max"),
      caption = "**Estimated Size of Age-1, Age-2 and Age-3 Sockeye Salmon captured in the Fulmore River in spring 2024.**",
      digits = 1) %>%
  #column_spec(c(1, 3,10,17), bold = TRUE) %>%
  kable_styling("striped", full_width =  FALSE,
                position = "center", 
                font_size = 12,
                fixed_thead = TRUE) %>%
  add_header_above(c(" " = 3, "Fork Length" = 5, "Weight (g)" = 5)) 

```
### Exploring the Sockeye Length-Frequency Distribution

To assess why the length-frequency plot has a multimodal distribution we can length vs weight. If this plot showed two distinct clusters it would be reasonable to assume that the difference in length was due primarily to differences in age between smolts (e.g., there would be a clear difference in the size of Age-1 and Age-2 fish). But interestingly, this is not what the length vs weight plot shows. Instead, the plot shows that for a given fork length, there are considerable and distinct differences in weight. Suggesting that there are likely two age-classes AND that smolts from both age groups are emigrating from different rearing environments - one that appears to be more productive (heavier fish at length), and one that is relatively less productive (lighter fish at length).  

```{r sockeye scatter plot, echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Fork length and weight of Sockeye Salmon captured in the Fulmore River."}


ggplot(SK_dat) + 
      geom_point(aes(x = Length, y = Weight, color = AgeClass)) +
      plottheme()
```

This difference becomes more apparent when we plot Fulton's condition factor (k) vs length. This figure (below) shows four distinct groups, presumably representing the two age classes and two rearing environments. 

```{r,  echo = FALSE, message = FALSE, warning = FALSE,fig.cap = "Length and condition of Sockeye Salmon captured in the Fulmore River."}
sk_cond <- ggplot(SK_dat) + 
              geom_point(aes(x = Length, y = Condition, color = AgeClass)) +
              labs(x = "Fork Length (mm)", y = "Condition Factor (k)") +
              plottheme()
sk_cond
              
```

If we apply this information on condition factor to our original length vs weight plot we get the plot below, which may indicate that our initial age assignment (Age 1 < 120 mm, Age 2 > 120 mm) may also need to take rearing environment into account. Specifically, fish originating from the less productive environment appear to be a smaller size (length and weight) at age than fish originating from the more productive environment.  

```{r,  echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "Fork length and weight of Sockeye Salmon captured in the Fulmore River, with emphasis on difference in condition."}
SK_dat2 <- SK_dat %>%
              mutate(RearingEnv = ifelse(Condition>=0.00115,"Enviro. A", "Enviro. B"),
                     RearingEnv = factor(RearingEnv, 
                                       levels = c("Enviro. A", "Enviro. B"))) %>%
              filter(!is.na(RearingEnv))


ggplot(SK_dat2) + 
      geom_point(aes(x = Length, y = Weight, color = AgeClass, shape = RearingEnv)) +
      scale_shape_manual(values = c(1, 3)) +
      labs(x = "Fork Length (mm)", y = "Weight (g)") +
      plottheme()

```

The data suggests there is a physiological difference among smolts and that this difference may be explained by rearing environment, competition, or some other factor that would limit growth. To see if there is a behavioural difference between groups we can re-plot the length-frequency figure to show the number of fish from each environment that were captured per week of trapping. A difference in migration timing between groups would further reinforce the assumption that these fish are originating from different environments.


```{r SK_FL, echo = FALSE, warning = FALSE, fig.cap = "Length-frequency distribution for Sockeye Salmon captured in the Fulmore River.", message = FALSE, fig.dim=c(10,18)}
#, out.height="1200px"
## Prepare Plots ----
## * Length Frequency Plots  ----  
## ** Prepare Data
    ## Total tally by fork length
    SK_LF_data <- SK_dat2 %>% 
                          group_by(Length) %>%
                          summarize(Count = n()) %>%
                          mutate(Date = "All Dates") %>%
                          select("Date","Length","Count")

    ## Weekly tally by fork length
    SK_weekly_catch <- SK_dat2 %>%
                      mutate(Date = isoweek(ymd(Date))) %>%  # convert date to weeknumber
                      group_by(Date, RearingEnv, Length) %>%
                        summarize(Count = n()) %>%
                        select("Date","Length","Count") %>%
                        mutate(Date = as.character(Date))

    ## Merge Total and Weekly Tally
    SK_total_weekly <- rbind(SK_weekly_catch, SK_LF_data) %>%
                        filter(!is.na(RearingEnv))

        
## ** Prepare Daily Length Frequency Plots
    ## All Catches
    all_fl.plot <- ggplot(SK_LF_data) +
                         geom_col(aes(x = Length, y = Count)) + 
                         labs(x = "Fork Lenght (mm)", y = "Frequency (# Fish)") +
                         scale_x_continuous(breaks = seq(70, 210, by = 2))+
                         scale_y_continuous(breaks = seq(0, 30, 2))+
                         plottheme() +
                         theme(axis.text.x = element_text(angle = 45, vjust = 1.2, hjust = 1)) 
 
    ## Faceted by Week
    SK_weekly_fl.plot <- ggplot(SK_total_weekly) + 
                      geom_col(aes(x = Length, y = Count)) + 
                      labs(x = "Fork Lenght (mm)", y = "Frequency (# Fish)") +
                      scale_x_continuous(breaks = seq(70, 210, by = 2))+
                      scale_y_continuous(breaks = seq(0, 50, 2))+
                      plottheme() +
                      facet_grid(Date~RearingEnv)
    
## ** Select Figures to Display
    #all_fl.plot
    SK_weekly_fl.plot
``` 


```{r plot of cumulative catches over time}
    cum.sk <- SK_dat2 %>%
              group_by(Date, RearingEnv) %>%
              summarize(Count = n(),
                        Prop  = Count/sum(Count),
                        cumsum = cumsum(Count)) %>%
              select("Date","RearingEnv","Count", "Prop", "cumsum") %>%
              mutate(Date = as.character(Date))

      cum.sk.plot <- ggplot(cum.sk) +
                       geom_col(aes(x = Date, y = cumsum)) + 
                       labs(x = "", y = "Frequency (# Fish)") +
                       #scale_x_continuous(breaks = seq(70, 210, by = 2))+
                       #scale_y_continuous(breaks = seq(0, 250, 25))+
                       plottheme() +
                       facet_grid(RearingEnv~.)
      
      cum.sk.plot
        

```
### Sockeye Salmon Data Summary
Based on the above plots, it is reasonable to speculate that:
  1. There are at least 2 age classes of Sockeye Salmon smolts emigrating from the Fulmore watershed.
  2. Analysis of scale samples will be required to verify the age-bins assigned in this preliminary assessment.
  3. Sockeye smolts appear to have originated from two locations, one of which produces fish in relatively better condition (i.e., higher weight for a given length).
  4. There appears to be a noticeable difference in migration behaviours between fish originating from each environment. Higher condition fish appear to migrate later than poorer condition fish... 
  5. The bulk of the migration occurred prior to trap installation, so it is unclear whether current results are representative of the entire run.


# Coho Salmon
```{r CO_FL, echo = FALSE, warning = FALSE, fig.cap = "Length-frequency distribution for all Coho Salmon captured in the Fulmore River.", message = FALSE, out.width= "1500px"}

## Prepare Plots ----
## * Length Frequency Plots  ----  
## ** Prepare Data
    ## Total tally by fork length
    co.dat <- catch_dat %>% 
                      filter(Species == "Coho Salmon")


    co.all_catches <- co.dat %>% 
                      group_by(Length) %>%
                      summarize(Count = n()) %>%
                      mutate(Date = "All Dates") %>%
                      select("Date","Length","Count")
    
    
## ** Prepare Daily Length Frequency Plots
    ## Faceted by Day
    co.fl.plot <- ggplot(co.all_catches) + 
                         geom_col(aes(x = Length, y = Count)) + 
                         labs(x = "Fork Lenght (mm)", y = "Frequency (# Fish)") +
                         scale_x_continuous(breaks = seq(0, 150, by = 5))+
                         # scale_y_continuous(breaks = seq(0, 50, 2))+
                         plottheme() +
                         theme(axis.text.x = element_text(angle = 45, vjust = 1.2, hjust = 1)) +
                         facet_grid(Date ~.)

    ## ** Select Figures to Display
    
    co.fl.plot

```  


```{r CO_lenght_weight, echo = FALSE, warning = FALSE}
co.plot_flwt <- ggplot(co.dat) +
                geom_point(aes(x = Length, y = Weight)) +
                labs (x = "Fork Length (mm)", y = "Weight (g)")

```


